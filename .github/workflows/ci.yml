name: CI

on:
  pull_request:
    branches:
      - main

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      go: ${{ steps.filter.outputs.go }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            go:
              - '**.go'
              - 'go.mod'
              - 'go.sum'
            docs:
              - 'docs/reference/**'
              - 'scripts/sync-plugin-docs.sh'

  lint:
    needs: check-changes
    if: needs.check-changes.outputs.go == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.26.0"
          cache: true

      - name: Check go mod tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.9.0

      - name: Check format
        run: |
          golangci-lint fmt ./...
          git diff --exit-code

  integration-test:
    needs: check-changes
    if: needs.check-changes.outputs.go == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.26.0"
          cache: true

      - name: Run integration tests
        run: go test -tags=integration -count=1 ./...

  completion-check:
    needs: check-changes
    if: needs.check-changes.outputs.go == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.26.0"
          cache: true

      - name: Build twig
        run: go build -o ./out/twig ./cmd/twig

      - name: Check completion scripts are up to date
        run: |
          ./out/twig completion bash > completion/twig.bash
          ./out/twig completion zsh > completion/twig.zsh
          ./out/twig completion fish > completion/twig.fish
          ./out/twig completion powershell > completion/twig.ps1
          git diff --exit-code completion/

  plugin-docs-check:
    needs: check-changes
    if: needs.check-changes.outputs.docs == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Sync plugin docs
        run: ./scripts/sync-plugin-docs.sh

      - name: Check plugin docs are up to date
        run: |
          git diff external/claude-code/plugins/
          if ! git diff --quiet external/claude-code/plugins/; then
            echo "::error::Plugin docs are out of sync. Run 'make sync-plugin-docs' and commit."
            exit 1
          fi

  required-checks:
    needs: [lint, integration-test, completion-check, plugin-docs-check]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo '${{ toJSON(needs) }}' | jq -e 'all(.[]; .result == "success" or .result == "skipped")'
